from django.core.urlresolvers import reverse_lazy
from django.views import generic
from django.http import HttpResponse
from django.shortcuts import render, redirect
from django.contrib import messages
from django.contrib.auth import authenticate, login, logout

from .excel import ExcelGenerator
from .analysis_graph import GraphGenerator
from .forms import AnalysisForm, LoginForm, PasswordResetForm

from braces import views


class AnalysisView(generic.TemplateView):
    template_name = 'analysis.html'

    def get(self, request, *args, **kwargs):
        # Try to pull out the data from the session, if no data (in case
        # when the user directly visits the analysis view), redirect to
        # the analyze view
        try:
            data = self.request.session['data']
        except KeyError:
            return redirect(reverse_lazy('analyze'))

        # Not removing the data from the session variable so that if the
        # user reloads the page, the data is not lost
        return render(self.request, 'analysis.html', dictionary={'data': data})


class AnalyserFormView(views.LoginRequiredMixin, generic.FormView):
    form_class = AnalysisForm
    template_name = 'analyze.html'
    success_url = reverse_lazy('analysis')

    def form_valid(self, form):
        college_code = form.cleaned_data['college_code']
        branch_code = form.cleaned_data['branch_code']
        sem = form.cleaned_data['semester']

        # get_form_kwargs() returns all the data from the form which includes
        # which button was pressed (analyze/download)

        data = self.get_form_kwargs()['data'].keys()

        # Check if user has clicked on download or not
        if 'download' in data:

            # Downloading logic here
            obj = ExcelGenerator(college_code, branch_code, int(sem))
            output = obj.excel_creator()

            # Check if the excel is generated by checking the type of the output
            # if output is an instance of string, then the excel wasn't
            # generated

            if not isinstance(output, str):
                # if excel is generated, then provide the download
                output.seek(0)
                response = HttpResponse(output.read(),
                                        content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                response['Content-Disposition'] = 'attachment; filename="test.xlsx"'
                return response
            else:
                # If excel can't be generated return a message
                messages.error(self.request, "Sorry, the Excel can't be "
                                             "generated for the given data ")
                return self.form_invalid(form)

        # Redirect to analysis if the user has clicked the analyze button
        else:

            obj = GraphGenerator(college_code, branch_code, int(sem))
            data = obj.graph_selector()

            # Add the data to the session and redirect to the analysis page
            # where this data will be used to generate the graph
            self.request.session['data'] = data

            return redirect(reverse_lazy('analysis'))


class LoginView(views.AnonymousRequiredMixin, generic.FormView):
    form_class = LoginForm
    template_name = 'login.html'
    success_url = 'analyze/'

    authenticated_redirect_url = reverse_lazy('analyze')

    def form_valid(self, form):
        username = form.cleaned_data['username']
        password = form.cleaned_data['password']
        user = authenticate(username=username, password=password)

        if user is not None and user.is_active:
            login(self.request, user)
            return super(LoginView, self).form_valid(form)
        else:
            return self.form_invalid(form)


class LogOutView(generic.RedirectView):
    url = reverse_lazy('login')

    def get(self, request, *args, **kwargs):
        logout(request)
        return super(LogOutView, self).get(request, *args, **kwargs)


class PasswordChangeView(views.LoginRequiredMixin, generic.FormView):
    login_url = reverse_lazy('login')
    form_class = PasswordResetForm
    template_name = 'password_reset.html'
    success_url = reverse_lazy('analyze')

    def form_valid(self, form):
        user = authenticate(username=self.request.user,
                            password=form.cleaned_data['old_password'])
        if user is not None:
            if form.cleaned_data['password1'] == form.cleaned_data['password2']:
                user.set_password(form.cleaned_data['password1'])
                user.save()
                return super(PasswordChangeView, self).form_valid(form)
        return self.form_invalid(form)